#!/usr/bin/perl -w

@ARGV==1 or die "usage: lgm2gnu <geometry>\n";
$real='[+-]*\d+\.*\d*e[+-]\d+|[+-]*\d+\.\d*|\d+';

# admin
if (-e "gnu") {system("rm -r gnu");}
system("mkdir gnu");

# functions
sub min
{
	$min_min=1000000;
	for ($min_i=0; $min_i<@_; $min_i++) {if ($min_min>$_[$min_i]) {$min_min=$_[$min_i];}}
	return ($min_min);
}
sub max 
{
	$max_max=-100000000;
	for ($max_i=0; $max_i<@_; $max_i++) {if ($max_max<$_[$max_i]) {$max_max=$_[$max_i];}}
	return ($max_max);
}

# check dimension
$dim=2;
open(IN,$ARGV[0]);
while($line=<IN>)
{
	if ($line=~/surface/)
	{
		$dim=3;
		last;
	}
}
close(IN);
print "dimension $dim detected\n";

if ($dim==2)
{
	# admin
	open(IN,$ARGV[0]);
	$sd_min=1000000; $sd_max=-1;

	# get lines
	$l=0;
	while($line=<IN>)
	{
		if ($line=~/points:/)
		{
			$n[$l]=0;
			if (!($line=~/left=(\d+);\s*right=(\d+)/)) {die "ERROR: cannot read left/right info\n";}
			$left[$l]=$1; $right[$l]=$2;
			if ($left[$l]==$right[$l]) {die "ERROR: line $l references subdomain $$right[$l] on both sides\n";}
			$sd_max=max($sd_max,$1,$2);
			$sd_min=min($sd_min,$1,$2);
			$line=~s/line\s*\d+:\s*left=\d+;\s*right=\d+;\s*points:\s*//g;
			while(1)
			{
				if ($line=~/(\d+)\s*/)
				{
					$lp[$l][$n[$l]++]=$1;			
					$line=~s/\d+\s*//;
				}
				else
				{
					last;
				}
			}
			$l++;
		}
		if ($line=~/Point-Info/) {last;}
	}

	# get points
	$m=0;
	while($line=<IN>)
	{
		if ($line=~/\s*($real)\s+($real)/)
		{
			$p[$m][0]=$1; $p[$m][1]=$2; $p_ref[$m]=0;
			$m++;
		}
	}
	close(IN);
	if ($m<3) {print "ERROR: $m points detected\n";}
	else {print "$m points detected\n";}

	# check point references
	for ($i=0; $i<$l; $i++)
	{
		for ($j=0; $j<$n[$i]; $j++)
		{
			$p_ref[$lp[$i][$j]]=1;
		}
	}
	$err=0; 
	for ($i=0; $i<$m; $i++) 
	{
		if ($p_ref[$i]==0)
		{
			$err=1;
			print "ERROR: point $i not referenced\n";
		}
	}
	if (!$err) {$i=$m-1; print "point 0 ... $i referenced correctly\n";}

	# check subdomains
	$err=0; for ($i=0; $i<=$sd_max; $i++) {$sd_ref[$i]=0;}
	for ($i=0; $i<$l; $i++) {$sd_ref[$left[$i]]=1; $sd_ref[$right[$i]]=1;}
	for ($i=0; $i<=$sd_max; $i++) 
	{
		if (!$sd_ref[$i]) {print "ERROR: subdomain $i not referenced\n";$err=1;}
		else
		{
			$nl=0;
			for ($j=0; $j<$l; $j++) 
			{
				if ($left[$j]==$i)
				{
					$start[$nl]=$lp[$j][0];
					$end[$nl]=$lp[$j][$n[$j]-1];
					$nl++;
				}
				if ($right[$j]==$i)
				{
					$end[$nl]=$lp[$j][0];
					$start[$nl]=$lp[$j][$n[$j]-1];
					$nl++;
				}
			}
			for ($j=0; $j<$nl; $j++)
			{
				$sum=0;
				for ($k=0; $k<$nl; $k++) 
				{
					if( $start[$j]==$end[$k] )
					{
						$sum++;
					}
				}
				if ($sum!=1) {print "ERROR: subdomain $i not surrounded correctly\n"; $err=1; last;}
			}
		}
	}
	if (!$err) {print "subdomain 0 ... $sd_max: ok\n";}

	# output 
	open(FULL,">gnu/full");
	for ($i=0; $i<$l; $i++)
	{
		for ($j=0; $j<$n[$i]; $j++)
		{
			$idx=$lp[$i][$j];
			print FULL "$p[$idx][0] $p[$idx][1];\n";
		}
		print FULL "\n";
	}
	close(FULL);
	for ($i=0; $i<=$sd_max; $i++)
	{
		open(OUT,">gnu/sd$i");
		for ($j=0; $j<$l; $j++)
		{
			if ($left[$j]!=$i && $right[$j]!=$i) {next;}
			for ($k=0; $k<$n[$j]; $k++)
			{
				$idx=$lp[$j][$k];
				print OUT "$p[$idx][0] $p[$idx][1];\n";
			}
			print OUT "\n";
		}
		close(OUT);
	}
}

if ($dim==3)
{
	print "sorry, not implemented yet\n";
}














